import { useState, useEffect } from 'react'
import { useAuth } from '../contexts/AuthContext'
import { DataService } from '../services/dataService'

// Hook pour g√©rer les donn√©es utilisateur avec Supabase
export const useSupabaseData = () => {
  const { user, isAuthenticated } = useAuth()
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState(null)
  
  // √âtats pour les donn√©es
  const [userSettings, setUserSettings] = useState(null)
  const [tradingJournal, setTradingJournal] = useState({})
  const [migrationCompleted, setMigrationCompleted] = useState(false)
  const [checklistTemplates, setChecklistTemplates] = useState([])
  const [userChecklistItems, setUserChecklistItems] = useState([])
  const [checklistSessions, setChecklistSessions] = useState([])
  const [activeTrade, setActiveTrade] = useState(null)

  // Charger les donn√©es utilisateur
  const loadUserData = async () => {
    if (!user?.id) return
    
    try {
      setLoading(true)
      setError(null)
      
      console.log('üìö Chargement des donn√©es utilisateur...')
      
      // Charger les param√®tres
      const settings = await DataService.getUserSettings(user.id)
      setUserSettings(settings)
      
      // Charger le journal
      const journal = await DataService.getTradingJournal(user.id)
      setTradingJournal(journal)
      
      // Charger les templates de checklist
      const templates = await DataService.getChecklistTemplates()
      setChecklistTemplates(templates)
      
      // Charger les items de checklist utilisateur
      const items = await DataService.getUserChecklistItems(user.id)
      setUserChecklistItems(items)
      
      // Charger les sessions de checklist r√©centes
      const sessions = await DataService.getChecklistSessions(user.id)
      setChecklistSessions(sessions)
      
      // Charger le trade actif s'il existe
      const trade = await DataService.getActiveTrade(user.id)
      setActiveTrade(trade)
      
      console.log('‚úÖ Donn√©es utilisateur charg√©es')
      
    } catch (err) {
      console.error('‚ùå Erreur chargement donn√©es:', err)
      setError(err)
    } finally {
      setLoading(false)
    }
  }

  // Migrer les donn√©es localStorage si n√©cessaire
  const migrateLocalData = async () => {
    if (!user?.id || migrationCompleted) return
    
    try {
      console.log('üîÑ V√©rification migration localStorage...')
      
      // V√©rifier s'il y a des donn√©es localStorage
      const localData = DataService.getLocalStorageData()
      
      if (Object.keys(localData).length > 0) {
        console.log('üì¶ Donn√©es localStorage trouv√©es, migration...')
        await DataService.migrateFromLocalStorage(user.id)
        
        // Recharger les donn√©es apr√®s migration
        await loadUserData()
      }
      
      setMigrationCompleted(true)
      
    } catch (err) {
      console.error('‚ùå Erreur migration:', err)
      setError(err)
    }
  }

  // Sauvegarder les param√®tres
  const saveSettings = async (newSettings) => {
    if (!user?.id) return
    
    try {
      console.log('üíæ Sauvegarde param√®tres...')
      const savedSettings = await DataService.saveUserSettings(user.id, newSettings)
      setUserSettings(savedSettings)
      return savedSettings
    } catch (err) {
      console.error('‚ùå Erreur sauvegarde param√®tres:', err)
      setError(err)
      throw err
    }
  }

  // Sauvegarder une entr√©e du journal
  const saveJournalEntry = async (date, entryData) => {
    if (!user?.id) return
    
    try {
      console.log('üíæ Sauvegarde entr√©e journal:', date)
      await DataService.saveTradingJournalEntry(user.id, date, entryData)
      
      // Mettre √† jour l'√©tat local
      setTradingJournal(prev => ({
        ...prev,
        [date]: entryData
      }))
      
      return true
    } catch (err) {
      console.error('‚ùå Erreur sauvegarde journal:', err)
      setError(err)
      throw err
    }
  }

  // Supprimer une entr√©e du journal
  const deleteJournalEntry = async (date) => {
    if (!user?.id) return
    
    try {
      console.log('üóëÔ∏è Suppression entr√©e journal:', date)
      await DataService.deleteTradingJournalEntry(user.id, date)
      
      // Mettre √† jour l'√©tat local
      setTradingJournal(prev => {
        const newJournal = { ...prev }
        delete newJournal[date]
        return newJournal
      })
      
      return true
    } catch (err) {
      console.error('‚ùå Erreur suppression journal:', err)
      setError(err)
      throw err
    }
  }
  
  // Supprimer toutes les entr√©es du journal
  const deleteAllJournalEntries = async () => {
    if (!user?.id) return
    
    try {
      console.log('üóëÔ∏è Suppression de toutes les entr√©es du journal...')
      await DataService.deleteAllTradingJournalEntries(user.id)
      
      // Mettre √† jour l'√©tat local
      setTradingJournal({})
      
      return true
    } catch (err) {
      console.error('‚ùå Erreur suppression globale journal:', err)
      setError(err)
      throw err
    }
  }

  // Sauvegarder une analyse IA
  const saveAIAnalysis = async (analysisData, modelUsed, provider) => {
    if (!user?.id) return
    
    try {
      console.log('üíæ Sauvegarde analyse IA...')
      return await DataService.saveAIAnalysis(user.id, analysisData, modelUsed, provider)
    } catch (err) {
      console.error('‚ùå Erreur sauvegarde analyse IA:', err)
      setError(err)
      throw err
    }
  }

  // Sauvegarder un calcul de position
  const savePositionCalculation = async (calculationData) => {
    if (!user?.id) return
    
    try {
      console.log('üíæ Sauvegarde calcul position...')
      return await DataService.savePositionCalculation(user.id, calculationData)
    } catch (err) {
      console.error('‚ùå Erreur sauvegarde calcul:', err)
      setError(err)
      throw err
    }
  }
  
  // === CHECKLIST FUNCTIONS ===
  
  // Sauvegarder un item de checklist
  const saveUserChecklistItem = async (itemData) => {
    if (!user?.id) return
    
    try {
      console.log('üíæ Sauvegarde item checklist...')
      const saved = await DataService.saveUserChecklistItem(user.id, itemData)
      
      // Mettre √† jour l'√©tat local
      setUserChecklistItems(prev => [...prev, saved])
      
      return saved
    } catch (err) {
      console.error('‚ùå Erreur sauvegarde item:', err)
      setError(err)
      throw err
    }
  }
  
  // Mettre √† jour un item de checklist
  const updateUserChecklistItem = async (itemId, updates) => {
    if (!user?.id) return
    
    try {
      console.log('üíæ Mise √† jour item checklist...')
      const updated = await DataService.updateUserChecklistItem(user.id, itemId, updates)
      
      // Mettre √† jour l'√©tat local
      setUserChecklistItems(prev => 
        prev.map(item => item.id === itemId ? updated : item)
      )
      
      return updated
    } catch (err) {
      console.error('‚ùå Erreur mise √† jour item:', err)
      setError(err)
      throw err
    }
  }
  
  // Supprimer un item de checklist
  const deleteUserChecklistItem = async (itemId) => {
    if (!user?.id) return
    
    try {
      console.log('üóëÔ∏è Suppression item checklist...')
      await DataService.deleteUserChecklistItem(user.id, itemId)
      
      // Mettre √† jour l'√©tat local
      setUserChecklistItems(prev => prev.filter(item => item.id !== itemId))
      
      return true
    } catch (err) {
      console.error('‚ùå Erreur suppression item:', err)
      setError(err)
      throw err
    }
  }
  
  // Copier les templates par d√©faut
  const copyDefaultTemplates = async () => {
    if (!user?.id) return
    
    try {
      console.log('üìã Copie des templates par d√©faut...')
      await DataService.copyDefaultTemplates(user.id)
      
      // Recharger les items utilisateur
      const items = await DataService.getUserChecklistItems(user.id)
      setUserChecklistItems(items)
      
      return true
    } catch (err) {
      console.error('‚ùå Erreur copie templates:', err)
      setError(err)
      throw err
    }
  }
  
  // Sauvegarder une session de checklist
  const saveChecklistSession = async (sessionData) => {
    if (!user?.id) return
    
    try {
      console.log('üíæ Sauvegarde session checklist...')
      const saved = await DataService.saveChecklistSession(user.id, sessionData)
      
      // Ajouter √† l'√©tat local
      setChecklistSessions(prev => [saved, ...prev])
      
      return saved
    } catch (err) {
      console.error('‚ùå Erreur sauvegarde session:', err)
      setError(err)
      throw err
    }
  }
  
  // === ACTIVE TRADE FUNCTIONS ===
  
  // Cr√©er un trade actif
  const createActiveTrade = async (tradeData) => {
    if (!user?.id) return
    
    try {
      console.log('üíæ Cr√©ation trade actif...')
      const created = await DataService.createActiveTrade(user.id, tradeData)
      
      // Mettre √† jour l'√©tat local
      setActiveTrade(created)
      
      return created
    } catch (err) {
      console.error('‚ùå Erreur cr√©ation trade:', err)
      setError(err)
      throw err
    }
  }
  
  // Fermer le trade actif
  const closeActiveTrade = async (exitSessionId) => {
    if (!user?.id || !activeTrade) return
    
    try {
      console.log('üíæ Fermeture trade actif...')
      const closed = await DataService.closeActiveTrade(user.id, activeTrade.id, exitSessionId)
      
      // Mettre √† jour l'√©tat local
      setActiveTrade(null)
      
      return closed
    } catch (err) {
      console.error('‚ùå Erreur fermeture trade:', err)
      setError(err)
      throw err
    }
  }

  // Effet pour charger les donn√©es quand l'utilisateur change
  useEffect(() => {
    if (isAuthenticated && user?.id) {
      loadUserData().then(() => {
        migrateLocalData()
      })
    } else {
      // Reset des donn√©es si pas connect√©
      setUserSettings(null)
      setTradingJournal({})
      setMigrationCompleted(false)
      setLoading(false)
    }
  }, [user?.id, isAuthenticated])

  return {
    // √âtats
    loading,
    error,
    userSettings,
    tradingJournal,
    migrationCompleted,
    checklistTemplates,
    userChecklistItems,
    checklistSessions,
    activeTrade,
    
    // Actions
    loadUserData,
    saveSettings,
    saveJournalEntry,
    deleteJournalEntry,
    deleteAllJournalEntries,
    saveAIAnalysis,
    savePositionCalculation,
    
    // Checklist Actions
    saveUserChecklistItem,
    updateUserChecklistItem,
    deleteUserChecklistItem,
    copyDefaultTemplates,
    saveChecklistSession,
    
    // Active Trade Actions
    createActiveTrade,
    closeActiveTrade,
    
    // Helpers
    clearError: () => setError(null),
    isDataLoaded: !loading && userSettings !== null
  }
} 